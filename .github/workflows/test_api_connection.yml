name: Test NBA API Connection

on:
  workflow_dispatch: # Manual trigger button in GitHub Actions UI

jobs:
  test-nba-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Test NBA API Connection with Headers
        run: |
          python -c "
          from nba_api.stats.endpoints import scoreboardv2
          from datetime import datetime
          
          # Configure headers per nba_api v1.1.0+ documentation
          # Must pass headers to EACH endpoint call, not globally
          print('üîß Testing NBA API with browser headers...')
          custom_headers = {
              'Host': 'stats.nba.com',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'application/json, text/plain, */*',
              'Accept-Language': 'en-US,en;q=0.9',
              'Accept-Encoding': 'gzip, deflate, br',
              'Connection': 'keep-alive',
              'Referer': 'https://www.nba.com/',
              'Origin': 'https://www.nba.com',
              'x-nba-stats-origin': 'stats',
              'x-nba-stats-token': 'true'
          }
          
          # Test API call with headers and timeout passed directly
          print('\\nüì° Fetching today\\'s games from NBA API...')
          today = datetime.now().strftime('%m/%d/%Y')
          print(f'Date: {today}, Timeout: 90s')
          
          try:
              board = scoreboardv2.ScoreboardV2(
                  game_date=today,
                  headers=custom_headers,
                  timeout=90
              )
              games = board.get_data_frames()[0]
              print(f'‚úÖ SUCCESS! Retrieved {len(games)} games')
              if len(games) > 0:
                  print(f'\\nFirst game status: {games.iloc[0][\"GAME_STATUS_TEXT\"]}')
              else:
                  print('\\nNo games scheduled for today')
          except Exception as e:
              print(f'‚ùå FAILED: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          
          print('\\nüéâ NBA API connection test passed!')
          "

      - name: Run Full Prediction Script
        run: |
          echo "Running full prediction script..."
          python scripts/update_frontend_data.py
        continue-on-error: true
        
      - name: Check Output Files
        run: |
          echo "Checking if output files were created..."
          if [ -f "frontend/public/data/today.json" ]; then
            echo "‚úÖ today.json created"
            head -20 frontend/public/data/today.json
          else
            echo "‚ùå today.json not found"
          fi
          
          if [ -f "frontend/public/data/lastweek.json" ]; then
            echo "‚úÖ lastweek.json created"
          else
            echo "‚ùå lastweek.json not found"
          fi
