name: Test NBA API Connection

on:
  workflow_dispatch: # Manual trigger button in GitHub Actions UI

jobs:
  test-nba-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Test NBA API Connection
        run: |
          python -c "
          from nba_api.stats.library.http import NBAStatsHTTP
          from nba_api.stats.endpoints import scoreboardv2
          from datetime import datetime, timedelta
          
          # Configure headers
          print('üîß Configuring NBA API headers...')
          nba_http = NBAStatsHTTP()
          nba_http.headers = {
              'Host': 'stats.nba.com',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'application/json, text/plain, */*',
              'Accept-Language': 'en-US,en;q=0.9',
              'Accept-Encoding': 'gzip, deflate, br',
              'Connection': 'keep-alive',
              'Referer': 'https://www.nba.com/',
              'Origin': 'https://www.nba.com',
              'x-nba-stats-origin': 'stats',
              'x-nba-stats-token': 'true'
          }
          nba_http.timeout = 60
          print('‚úÖ Headers configured')
          
          # Test API call
          print('\\nüì° Testing API connection with today\\'s games...')
          today = datetime.now().strftime('%m/%d/%Y')
          print(f'Fetching games for: {today}')
          
          try:
              board = scoreboardv2.ScoreboardV2(game_date=today)
              games = board.get_data_frames()[0]
              print(f'‚úÖ SUCCESS! Retrieved {len(games)} games')
              print(f'\\nResponse columns: {list(games.columns)[:10]}...')
              if len(games) > 0:
                  print(f'\\nFirst game: {games.iloc[0][\"GAME_STATUS_TEXT\"]}')
              else:
                  print('\\nNo games scheduled for today')
          except Exception as e:
              print(f'‚ùå FAILED: {e}')
              exit(1)
          
          print('\\nüéâ NBA API connection test passed!')
          "

      - name: Run Full Prediction Script (Optional Test)
        run: |
          echo "Running full prediction script as a final test..."
          python scripts/update_frontend_data.py
        continue-on-error: true
        
      - name: Check Output Files
        run: |
          echo "Checking if output files were created..."
          if [ -f "frontend/public/data/today.json" ]; then
            echo "‚úÖ today.json created"
            head -20 frontend/public/data/today.json
          else
            echo "‚ùå today.json not found"
          fi
          
          if [ -f "frontend/public/data/lastweek.json" ]; then
            echo "‚úÖ lastweek.json created"
          else
            echo "‚ùå lastweek.json not found"
          fi
